<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0" DefaultTargets="Build">
	<Target Name="MakeInstallPackage" Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
		<!-- Read package version from the manifest -->
		<XmlRead Prefix="n" Namespace="http://schemas.microsoft.com/developer/msbuild/2003"
			 XPath="/dotnetnuke/packages/package[1]/@version" XmlFileName="R7.Documents.dnn">
			<Output TaskParameter="Value" PropertyName="Version" />
		</XmlRead>
		<ItemGroup>
			<DefaultExclude Include="**\.git\**" />
			<DefaultExclude Include="**\.svn\**" />
			<DefaultExclude Include="**\bin\**" />
			<DefaultExclude Include="**\obj\**" />
			<DefaultExclude Include="**\Release\**" />
			<DefaultExclude Include="**\Debug\**" />
			<DefaultExclude Include="**\Test\**" />
			<DefaultExclude Include="**\TestResults\**" />
			<DefaultExclude Include="**\doc\**" />
			<DefaultExclude Include="**\www\**" />
			<DefaultExclude Include="**\*.user" />
			<DefaultExclude Include="**\*.suo" />
			<DefaultExclude Include="**\*.zip" />
			<DefaultExclude Include="**\*.txt" />
			<DefaultExclude Include="**\*ReSharper.*\**" />
		</ItemGroup>
		<ItemGroup>
			<InstallInclude Include="..\**\*.ascx" />
			<InstallInclude Include="..\**\*.asmx" />
			<InstallInclude Include="..\**\*.ashx" />
			<InstallInclude Include="..\**\*.css" />
			<InstallInclude Include="..\**\*.html" />
			<InstallInclude Include="..\**\*.htm" />
			<InstallInclude Include="..\**\*.resx" />
			<InstallInclude Include="..\**\*.aspx" />
			<InstallInclude Include="..\**\*.js" />
			<InstallInclude Include="..\**\images\*.*" />
		</ItemGroup>
		<!-- Declare manifest files -->
		<CreateItem Include="R7.Documents.dnn;License.txt;ReleaseNotes.txt">
			<Output TaskParameter="Include" ItemName="PackageManifestFiles" />
		</CreateItem>
		<!-- Declare binaries -->
		<CreateItem Include="$(MSBuildDnnBinPath)\R7.Documents*.dll">
			<Output TaskParameter="Include" ItemName="BinaryFiles" />
		</CreateItem>
		<!-- Declare files -->
		<CreateItem Include="..\R7.Documents\**\*.sqldataprovider">
			<Output TaskParameter="Include" ItemName="SqlDataProviderFiles" />
		</CreateItem>
		<!-- Copy binaries -->
		<Copy SourceFiles="@(BinaryFiles)" DestinationFolder="$(MSBuildProjectDirectory)\tmp_Package\bin" />
		<!-- Copy manifest and SqlDataProvider files -->
		<Copy SourceFiles="@(SqlDataProviderFiles)"
			 DestinationFolder="$(MSBuildProjectDirectory)\tmp_Package\%(RecursiveDir)" />
		<Copy SourceFiles="@(PackageManifestFiles)" DestinationFolder="$(MSBuildProjectDirectory)\tmp_Package" />
		<!-- Create the Resources.zip file -->
		<Copy SourceFiles="@(InstallInclude)"
			 DestinationFolder="$(MSBuildProjectDirectory)\tmp_Resources\%(RecursiveDir)" />
		<!-- Declare resources folder -->
		<CreateItem Include="$(MSBuildProjectDirectory)\tmp_Resources\**\*.*">
			<Output TaskParameter="Include" ItemName="ResourcesContent" />
		</CreateItem>
		<!-- Create Resources.zip -->
		<Zip Files="@(ResourcesContent)" WorkingDirectory="$(MSBuildProjectDirectory)\tmp_Resources"
			 ZipFileName="Resources.$(PackageExtension)" />
		<!--- Copy Resources.zip to tmp_Package folder -->
		<Copy SourceFiles="$(MSBuildProjectDirectory)\Resources.$(PackageExtension)"
			 DestinationFolder="$(MSBuildProjectDirectory)\tmp_Package/" />
		<!-- Declare tmp package folder -->
		<CreateItem Include="$(MSBuildProjectDirectory)\tmp_Package\**\*.*">
			<Output TaskParameter="Include" ItemName="OutputContent" />
		</CreateItem>
		<!-- Create the install package -->
		<Zip Files="@(OutputContent)" WorkingDirectory="$(MSBuildProjectDirectory)\tmp_Package"
			 ZipFileName="$(PackageName)-$(Version)-Install.$(PackageExtension)" />
		<!-- Copy the install package to the output directory -->
		<Copy SourceFiles="$(MSBuildProjectDirectory)\$(PackageName)-$(Version)-Install.$(PackageExtension)"
			 DestinationFolder="$(PackageOutputPath)/" />
		<!-- Cleanup -->
		<RemoveDir Directories="$(MSBuildProjectDirectory)\tmp_Package" />
		<RemoveDir Directories="$(MSBuildProjectDirectory)\tmp_Resources" />
		<Delete Files="$(MSBuildProjectDirectory)\Resources.$(PackageExtension)" />
		<Delete Files="$(MSBuildProjectDirectory)\$(PackageName)-$(Version)-Install.$(PackageExtension)" />
	</Target>
</Project>
