<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0" DefaultTargets="Build">
	<Target Name="MakeSourcePackage" Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
		<!-- Read package version from the manifest -->
		<XmlRead Prefix="n" Namespace="http://schemas.microsoft.com/developer/msbuild/2003"
			 XPath="/dotnetnuke/packages/package[1]/@version" XmlFileName="R7.Documents.dnn">
			<Output TaskParameter="Value" PropertyName="Version" />
		</XmlRead>
		<ItemGroup>
			<DefaultExclude Include="**\.git\**" />
			<DefaultExclude Include="**\.svn\**" />
			<DefaultExclude Include="**\bin\**" />
			<DefaultExclude Include="**\obj\**" />
			<DefaultExclude Include="**\Release\**" />
			<DefaultExclude Include="**\Debug\**" />
			<DefaultExclude Include="**\Test\**" />
			<DefaultExclude Include="**\TestResults\**" />
			<DefaultExclude Include="**\doc\**" />
			<DefaultExclude Include="**\www\**" />
			<DefaultExclude Include="**\*.user" />
			<DefaultExclude Include="**\*.suo" />
			<DefaultExclude Include="**\*.zip" />
			<DefaultExclude Include="**\*ReSharper.*\**" />
		</ItemGroup>
		<ItemGroup>
			<SourceInclude Include="..\**\*.sqldataprovider" />
			<SourceInclude Include="..\**\*.dnn" />
			<SourceInclude Include="..\**\*.ascx" />
			<SourceInclude Include="..\**\*.asmx" />
			<SourceInclude Include="..\**\*.ashx" />
			<SourceInclude Include="..\**\*.css" />
			<SourceInclude Include="..\**\*.xsl" />
			<SourceInclude Include="..\**\*.html" />
			<SourceInclude Include="..\**\*.htm" />
			<SourceInclude Include="..\**\*.resx" />
			<SourceInclude Include="..\**\*.xml" Exclude="..\**\obj\**;..\**\_ReSharper*\**;" />
			<SourceInclude Include="..\**\*.aspx" />
			<SourceInclude Include="..\**\*.js" />
			<SourceInclude Include="..\**\*.txt" Exclude="..\**\obj\**;..\**\_ReSharper*\**;" />
			<SourceInclude Include="..\**\images\*.*" />
			<SourceInclude Include="..\**\*.cs" />
			<SourceInclude Include="..\**\*.cs.designer" />
			<SourceInclude Include="..\**\*.cs.controls" />
			<SourceInclude Include="..\**\*.csproj" />
			<SourceInclude Include="..\**\*.targets" />
			<SourceInclude Include="..\**\*.sln" />
			<SourceInclude Include="..\**\*.md" />
		</ItemGroup>
		<!-- Copy source files to tmp package folder -->
		<Copy SourceFiles="@(SourceInclude)" DestinationFolder="$(MSBuildProjectDirectory)\tmp_Package\%(RecursiveDir)" />
		<!-- Declare tmp package folder -->
		<CreateItem Include="$(MSBuildProjectDirectory)\tmp_Package\**\*.*">
			<Output TaskParameter="Include" ItemName="OutputSource" />
		</CreateItem>
		<!-- Create source package -->
		<Zip Files="@(OutputSource)" WorkingDirectory="$(MSBuildProjectDirectory)\tmp_Package"
			 ZipFileName="$(PackageName)-$(Version)-Source.$(PackageExtension)" />
		<!-- Copy source package to the output directory -->
		<Copy SourceFiles="$(MSBuildProjectDirectory)\$(PackageName)-$(Version)-Source.$(PackageExtension)"
			 DestinationFolder="$(PackageOutputPath)/" />
		<!-- Cleanup -->
		<Delete Files="$(MSBuildProjectDirectory)\$(PackageName)-$(Version)-Source.$(PackageExtension)" />
		<RemoveDir Directories="$(MSBuildProjectDirectory)\tmp_Package" />
	</Target>
</Project>
